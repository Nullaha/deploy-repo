import{e as St}from"./deduplicate-9SSKgNqK.js";import{H as C}from"./InterleavedLayout-BrNCGDim.js";import{e as g}from"./VertexAttribute-BlT9lbVY.js";import{gF as P,jh as ht,g$ as ot,hq as Ot,f7 as H,bU as rt,bK as z,ho as Et,ji as At,bL as gt,bV as st,bN as Nt,bO as w,Z as Tt,bY as wt}from"./index-DaqWdlbg.js";import{x as vt,i as $t}from"./index-CW9mWlpJ.js";function J(t,e=0){const n=t.stride;return Array.from(t.fields.keys()).map(s=>{const r=t.fields.get(s),i=r.constructor.ElementCount,l=yt(r.constructor.ElementType),c=r.offset,p=!(!r.optional||!r.optional.glNormalized);return new ht(s,i,l,c,n,p,e)})}function yt(t){const e=Mt[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const Mt={u8:P.UNSIGNED_BYTE,u16:P.UNSIGNED_SHORT,u32:P.UNSIGNED_INT,i8:P.BYTE,i16:P.SHORT,i32:P.INT,f32:P.FLOAT},Pt=C().vec3f(g.POSITION).u16(g.COMPONENTINDEX),Rt=C().vec2u8(g.SIDENESS);J(Rt);const K=C().vec3f(g.POSITION0).vec3f(g.POSITION1).vec2i16(g.NORMALCOMPRESSED).u16(g.COMPONENTINDEX).u8(g.VARIANTOFFSET,{glNormalized:!0}).u8(g.VARIANTSTROKE).u8(g.VARIANTEXTENSION,{glNormalized:!0}),G=C().vec3f(g.POSITION0).vec3f(g.POSITION1).vec2i16(g.NORMALCOMPRESSED).vec2i16(g.NORMAL2COMPRESSED).u16(g.COMPONENTINDEX).u8(g.VARIANTOFFSET,{glNormalized:!0}).u8(g.VARIANTSTROKE).u8(g.VARIANTEXTENSION,{glNormalized:!0});g.POSITION0,g.POSITION1,g.COMPONENTINDEX,g.VARIANTOFFSET,g.VARIANTSTROKE,g.VARIANTEXTENSION,g.NORMALCOMPRESSED,g.NORMAL2COMPRESSED,g.SIDENESS;const R=-1;var it;function bt(t,e,n,s=Ft){const r=t.vertices.position,i=t.vertices.componentIndex,l=ot(s.anglePlanar),c=ot(s.angleSignificantEdge),p=Math.cos(c),f=Math.cos(l),u=k.edge,I=u.position0,S=u.position1,d=u.faceNormal0,v=u.faceNormal1,h=xt(t),$=Ct(t),o=$.length/4,a=e.allocate(o);let N=0;const m=o,O=n.allocate(m);let T=0,y=0,E=0;const Q=vt(0,o),F=new Float32Array(o);F.forEach((b,A,x)=>{r.getVec($[4*A],I),r.getVec($[4*A+1],S),x[A]=Ot(I,S)}),Q.sort((b,A)=>F[A]-F[b]);const tt=new Array,et=new Array;for(let b=0;b<o;b++){const A=Q[b],x=F[A],W=$[4*A],dt=$[4*A+1],D=$[4*A+2],_=$[4*A+3],nt=_===R;if(r.getVec(W,I),r.getVec(dt,S),nt)H(d,h[3*D],h[3*D+1],h[3*D+2]),rt(v,d),u.componentIndex=i.get(W),u.cosAngle=z(d,v);else{if(H(d,h[3*D],h[3*D+1],h[3*D+2]),H(v,h[3*_],h[3*_+1],h[3*_+2]),u.componentIndex=i.get(W),u.cosAngle=z(d,v),Vt(u,f))continue;u.cosAngle<-.9999&&rt(v,d)}y+=x,E++,nt||Dt(u,p)?(e.write(a,N++,u),tt.push(x)):Lt(u,l)&&(n.write(O,T++,u),et.push(x))}const pt=new Float32Array(tt.reverse()),It=new Float32Array(et.reverse());return{regular:{instancesData:e.trim(a,N),lodInfo:{lengths:pt}},silhouette:{instancesData:n.trim(O,T),lodInfo:{lengths:It}},averageEdgeLength:y/E}}function Dt(t,e){return t.cosAngle<e}function Vt(t,e){return t.cosAngle>e}function Lt(t,e){const n=Et(t.cosAngle),s=k.fwd,r=k.ortho;return At(s,t.position1,t.position0),n*(z(gt(r,t.faceNormal0,t.faceNormal1),s)>0?-1:1)>e}function Ct(t){const e=t.faces.length/3,n=t.faces,s=t.neighbors;let r=0;for(let c=0;c<e;c++){const p=s[3*c],f=s[3*c+1],u=s[3*c+2],I=n[3*c],S=n[3*c+1],d=n[3*c+2];r+=p===R||I<S?1:0,r+=f===R||S<d?1:0,r+=u===R||d<I?1:0}const i=new Int32Array(4*r);let l=0;for(let c=0;c<e;c++){const p=s[3*c],f=s[3*c+1],u=s[3*c+2],I=n[3*c],S=n[3*c+1],d=n[3*c+2];(p===R||I<S)&&(i[l++]=I,i[l++]=S,i[l++]=c,i[l++]=p),(f===R||S<d)&&(i[l++]=S,i[l++]=d,i[l++]=c,i[l++]=f),(u===R||d<I)&&(i[l++]=d,i[l++]=I,i[l++]=c,i[l++]=u)}return i}function xt(t){const e=t.faces.length/3,n=t.vertices.position,s=t.faces,r=X.v0,i=X.v1,l=X.v2,c=new Float32Array(3*e);for(let p=0;p<e;p++){const f=s[3*p],u=s[3*p+1],I=s[3*p+2];n.getVec(f,r),n.getVec(u,i),n.getVec(I,l),st(i,i,r),st(l,l,r),gt(r,i,l),Nt(r,r),c[3*p]=r[0],c[3*p+1]=r[1],c[3*p+2]=r[2]}return c}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(it||(it={}));const k={edge:{position0:w(),position1:w(),faceNormal0:w(),faceNormal1:w(),componentIndex:0,cosAngle:0},ortho:w(),fwd:w()},X={v0:w(),v1:w(),v2:w()},Ft={anglePlanar:4,angleSignificantEdge:35};function ct(t,e,n){const s=e/3,r=new Uint32Array(n+1),i=new Uint32Array(n+1),l=(o,a)=>{o<a?r[o+1]++:i[a+1]++};for(let o=0;o<s;o++){const a=t[3*o],N=t[3*o+1],m=t[3*o+2];l(a,N),l(N,m),l(m,a)}let c=0,p=0;for(let o=0;o<n;o++){const a=r[o+1],N=i[o+1];r[o+1]=c,i[o+1]=p,c+=a,p+=N}const f=new Uint32Array(6*s),u=r[n],I=(o,a,N)=>{if(o<a){const m=r[o+1]++;f[2*m]=a,f[2*m+1]=N}else{const m=i[a+1]++;f[2*u+2*m]=o,f[2*u+2*m+1]=N}};for(let o=0;o<s;o++){const a=t[3*o],N=t[3*o+1],m=t[3*o+2];I(a,N,o),I(N,m,o),I(m,a,o)}const S=(o,a)=>{const N=2*o,m=a-o;for(let O=1;O<m;O++){const T=f[N+2*O],y=f[N+2*O+1];let E=O-1;for(;E>=0&&f[N+2*E]>T;E--)f[N+2*E+2]=f[N+2*E],f[N+2*E+3]=f[N+2*E+1];f[N+2*E+2]=T,f[N+2*E+3]=y}};for(let o=0;o<n;o++)S(r[o],r[o+1]),S(u+i[o],u+i[o+1]);const d=new Int32Array(3*s),v=(o,a)=>o===t[3*a]?0:o===t[3*a+1]?1:o===t[3*a+2]?2:-1,h=(o,a)=>{const N=v(o,a);d[3*a+N]=-1},$=(o,a,N,m)=>{const O=v(o,a);d[3*a+O]=m;const T=v(N,m);d[3*m+T]=a};for(let o=0;o<n;o++){let a=r[o];const N=r[o+1];let m=i[o];const O=i[o+1];for(;a<N&&m<O;){const T=f[2*a],y=f[2*u+2*m];T===y?($(o,f[2*a+1],y,f[2*u+2*m+1]),a++,m++):T<y?(h(o,f[2*a+1]),a++):(h(y,f[2*u+2*m+1]),m++)}for(;a<N;)h(o,f[2*a+1]),a++;for(;m<O;)h(f[2*u+2*m],f[2*u+2*m+1]),m++}return d}function j(t,e,n,s,r,i=2){const l=1/(Math.abs(n)+Math.abs(s)+Math.abs(r)),c=n*l,p=s*l,f=r<=0?(c>=0?1:-1)*(1-Math.abs(p)):c,u=r<=0?(p>=0?1:-1)*(1-Math.abs(c)):p,I=e*i;t[I]=at(f),t[I+1]=at(u)}function at(t){return Tt(Math.round(32767*t),-32767,32767)}class mt{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?Bt:_t}write(e,n,s){const r=this._edgeHashFunction(s);B.seed=r;const i=B.getIntRange(0,255),l=B.getIntRange(0,this.settings.variants-1),c=.7,p=B.getFloat(),f=255*(.5*Ut(-(1-Math.min(p/c,1))+Math.max(0,p-c)/(1-c),1.2)+.5);e.position0.setVec(n,s.position0),e.position1.setVec(n,s.position1),e.componentIndex.set(n,s.componentIndex),e.variantOffset.set(n,i),e.variantStroke.set(n,l),e.variantExtension.set(n,f)}trim(e,n){return e.slice(0,n)}}const Z=new Float32Array(6),U=new Uint32Array(Z.buffer),M=new Uint32Array(1);function _t(t){const e=Z;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],M[0]=5381;for(let n=0;n<U.length;n++)M[0]=31*M[0]+U[n];return M[0]}function Bt(t){const e=Z;e[0]=V(t.position0[0]),e[1]=V(t.position0[1]),e[2]=V(t.position0[2]),e[3]=V(t.position1[0]),e[4]=V(t.position1[1]),e[5]=V(t.position1[2]),M[0]=5381;for(let n=0;n<U.length;n++)M[0]=31*M[0]+U[n];return M[0]}const ft=1e4;function V(t){return Math.round(t*ft)/ft}function Ut(t,e){const n=t<0?-1:1;return Math.abs(t)**e*n}class q{constructor(){this._commonWriter=new mt}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return K.createBuffer(e)}write(e,n,s){this._commonWriter.write(e,n,s),wt(L,s.faceNormal0,s.faceNormal1),Nt(L,L);const{typedBuffer:r,typedBufferStride:i}=e.normalCompressed;j(r,n,L[0],L[1],L[2],i)}trim(e,n){return this._commonWriter.trim(e,n)}}q.Layout=K,q.glLayout=J(K,1);class Y{constructor(){this._commonWriter=new mt}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return G.createBuffer(e)}write(e,n,s){this._commonWriter.write(e,n,s);{const{typedBuffer:r,typedBufferStride:i}=e.normalCompressed;j(r,n,s.faceNormal0[0],s.faceNormal0[1],s.faceNormal0[2],i)}{const{typedBuffer:r,typedBufferStride:i}=e.normal2Compressed;j(r,n,s.faceNormal1[0],s.faceNormal1[1],s.faceNormal1[2],i)}}trim(e,n){return this._commonWriter.trim(e,n)}}Y.Layout=G,Y.glLayout=J(G,1);const L=w(),B=new $t;function jt(t){const e=Wt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return lt.updateSettings(t.writerSettings),ut.updateSettings(t.writerSettings),bt(e,lt,ut)}function Wt(t,e,n,s){if(e){const l=ct(n,s,t.count);return new Ht(n,s,l,t)}const r=St(t.buffer,t.stride/4,{originalIndices:n,originalIndicesLength:s}),i=ct(r.indices,s,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:i,vertices:Pt.createView(r.buffer)}}class Ht{constructor(e,n,s,r){this.faces=e,this.facesLength=n,this.neighbors=s,this.vertices=r}}const lt=new q,ut=new Y,qt=C().vec3f(g.POSITION0).vec3f(g.POSITION1),Yt=C().vec3f(g.POSITION0).vec3f(g.POSITION1).u16(g.COMPONENTINDEX);export{Pt as I,bt as a,qt as d,jt as f,Yt as m,Wt as u};
